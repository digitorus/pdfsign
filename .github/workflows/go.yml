name: Build & Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: Build, Test & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Go 1.x
        uses: actions/setup-go@v5
        with:
          go-version: ^1.23

      - name: Build
        run: go build -v ./...

      - name: Test
        run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: Install pdfcpu
        run: go install github.com/pdfcpu/pdfcpu/cmd/pdfcpu@latest

      - name: Run PDF Validation
        run: |
          # Ensure pdfcpu is in PATH
          export PATH=$PATH:$(go env GOPATH)/bin
          
          VALIDATION_PASSED="true"
          echo "### PDF Validation Results"
          
          # Use find to handle sign_test.go output in testfiles/success/
          if [ ! -d "testfiles/success" ] || [ -z "$(ls -A testfiles/success 2>/dev/null)" ]; then
            echo "‚è≠Ô∏è No signed PDF files found. Skipping validation."
            exit 0
          fi

          # Build list of source files that have pre-existing errors (baseline)
          echo "Running baseline check..."
          for source_file in testfiles/*.pdf; do
            [ -e "$source_file" ] || continue
            filename=$(basename "$source_file")
            if ! pdfcpu validate -mode strict "$source_file" > /dev/null 2>&1; then
              echo "$filename" >> baseline_errors.txt
              echo "Baseline skip: $filename (source has pre-existing errors)"
            fi
          done

          # Validate signed files
          find testfiles/success -name "*.pdf" | sort | while read signed_file; do
            filename=$(basename "$signed_file")
            
            # Extract the original source filename by removing the test suffix
            # e.g., testfile14_TestSignPDF.pdf -> testfile14.pdf
            # e.g., testfile14_TestSignPDFVisibleAll.pdf -> testfile14.pdf
            source_filename=$(echo "$filename" | sed 's/_TestSignPDF.pdf/.pdf/' | sed 's/_TestSignPDFVisibleAll.pdf/.pdf/')
            
            # Skip if source had pre-existing errors
            if [ -f baseline_errors.txt ] && grep -q "^$source_filename$" baseline_errors.txt; then
              echo "--------------------------------------------------"
              echo "‚è≠Ô∏è  $filename (skipped - source '$source_filename' has pre-existing errors)"
              continue
            fi
            
            echo "--------------------------------------------------"
            echo "üìÑ Validating: $filename"
            
            # Structure validation
            if pdfcpu validate -mode strict "$signed_file" > /dev/null 2>&1; then
              echo "‚úÖ Structure: OK"
            else
              echo "‚ùå Structure: FAILED"
              pdfcpu validate -mode strict "$signed_file" 2>&1 || true
              VALIDATION_PASSED="false"
              touch validation_failed.flag
            fi
            
            # Signature validation
            SIG_OUT=$(pdfcpu signatures validate -f "$signed_file" 2>&1)
            if echo "$SIG_OUT" | grep -q "DocModified: false"; then
              echo "‚úÖ Signature: Integrity verified (Document not modified)"
            else
              echo "‚ùå Signature: FAILED"
              echo "$SIG_OUT"
              VALIDATION_PASSED="false"
              touch validation_failed.flag
            fi
          done

          if [ -f validation_failed.flag ]; then
            echo ""
            echo "‚ùå PDF validation failed. See log above for details."
            exit 1
          else
            echo ""
            echo "‚úÖ All PDF validations passed!"
          fi

      - name: Upload coverage report
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.txt
          flags: unittests
          name: codecov-umbrella

      - name: Upload test PDF files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-pdf-artifacts
          path: testfiles/success/
          retention-days: 7

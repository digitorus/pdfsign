name: Build & Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: Build, Test & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Go 1.x
        uses: actions/setup-go@v5
        with:
          go-version: ^1.23

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build
        run: go build -v ./...

      - name: Test
        run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: Install pdfcpu
        run: go install github.com/pdfcpu/pdfcpu/cmd/pdfcpu@latest

      - name: Run PDF Validation
        run: |
          # Ensure pdfcpu is in PATH
          export PATH=$PATH:$(go env GOPATH)/bin
          
          VALIDATION_PASSED="true"
          echo "### PDF Validation Results"
          
          # Use find to handle sign_test.go output in testfiles/success/
          if [ ! -d "testfiles/success" ] || [ -z "$(ls -A testfiles/success 2>/dev/null)" ]; then
            echo "â­ï¸ No signed PDF files found. Skipping validation."
            exit 0
          fi

          # Build list of source files that have pre-existing errors (baseline)
          echo "Running baseline check..."
          for source_file in testfiles/*.pdf; do
            [ -e "$source_file" ] || continue
            filename=$(basename "$source_file")
            if ! pdfcpu validate -mode strict "$source_file" > /dev/null 2>&1; then
              echo "$filename" >> baseline_errors.txt
              echo "Baseline skip: $filename (source has pre-existing errors)"
            fi
          done

          # Validate signed files
          find testfiles/success -name "*.pdf" | sort | while read signed_file; do
            filename=$(basename "$signed_file")
            
            # Extract the original source filename by removing the test suffix
            # e.g., testfile14_TestSignPDF.pdf -> testfile14.pdf
            # e.g., testfile14_TestSignPDFVisibleAll.pdf -> testfile14.pdf
            source_filename=$(echo "$filename" | sed 's/_TestSignPDF.pdf/.pdf/' | sed 's/_TestSignPDFVisibleAll.pdf/.pdf/')
            
            # Skip if source had pre-existing errors
            if [ -f baseline_errors.txt ] && grep -q "^$source_filename$" baseline_errors.txt; then
              echo "--------------------------------------------------"
              echo "â­ï¸  $filename (skipped - source '$source_filename' has pre-existing errors)"
              continue
            fi
            
            echo "--------------------------------------------------"
            echo "ðŸ“„ Validating: $filename"
            
            # Structure validation
            if pdfcpu validate -mode strict "$signed_file" > /dev/null 2>&1; then
              echo "âœ… Structure: OK"
            else
              echo "âŒ Structure: FAILED"
              pdfcpu validate -mode strict "$signed_file" 2>&1 || true
              VALIDATION_PASSED="false"
              touch validation_failed.flag
            fi
            
            # Signature validation
            SIG_OUT=$(pdfcpu signatures validate -f "$signed_file" 2>&1)
            if echo "$SIG_OUT" | grep -q "DocModified: false"; then
              echo "âœ… Signature: Integrity verified (Document not modified)"
            else
              echo "âŒ Signature: FAILED"
              echo "$SIG_OUT"
              VALIDATION_PASSED="false"
              touch validation_failed.flag
            fi
          done

          if [ -f validation_failed.flag ]; then
            echo ""
            echo "âŒ PDF validation failed. See log above for details."
            exit 1
          else
            echo ""
            echo "âœ… All PDF validations passed!"
          fi

      - name: Run DSS Validation
        continue-on-error: true
        run: |
          # Clone DSS demonstrations
          git clone --depth 1 https://github.com/esig/dss-demonstrations.git
          cd dss-demonstrations/dss-demo-webapp
          
          # Start DSS Service via Maven
          mvn spring-boot:run > dss-startup.log 2>&1 &
          DSS_PID=$!
          
          echo "Waiting for DSS Service to start..."
          # Wait for service to be healthy (up to 5 minutes)
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/services/rest/validation/v2/validateSignature | grep -E "405|415|200" > /dev/null; then
              echo "DSS Service is up!"
              break
            fi
            echo "Waiting for DSS Service (attempt $i)..."
            sleep 5
            if [ $i -eq 60 ]; then
              echo "âŒ DSS Service failed to start"
              cat dss-startup.log
              kill $DSS_PID || true
              exit 1
            fi
          done

          cd ../..
          # Run validation test
          echo "### DSS Signature Validation Results"
          DSS_API_URL=http://localhost:8080/services/rest/validation/v2/validateSignature go test -v ./sign -run TestSignDSSValidation
          
          # Cleanup
          kill $DSS_PID || true

      - name: Upload coverage report
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.txt
          flags: unittests
          name: codecov-umbrella

      - name: Upload test PDF files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-pdf-artifacts
          path: testfiles/success/
          retention-days: 7

  corpus-test:
    name: Corpus Security Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Go 1.x
        uses: actions/setup-go@v5
        with:
          go-version: ^1.23

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install validators
        run: |
          sudo apt-get update
          sudo apt-get install -y ghostscript
          go install github.com/pdfcpu/pdfcpu/cmd/pdfcpu@latest
          
          # Install veraPDF greenfield
          curl -L https://downloads.verapdf.org/rel/1.28/verapdf-greenfield-1.28.2-installer.zip -o verapdf.zip
          unzip verapdf.zip
          VERAPDF_DIR=$(find . -maxdepth 1 -type d -name "verapdf-greenfield-*" | head -n 1)
          echo "VERAPDF_DIR=$VERAPDF_DIR" >> $GITHUB_ENV
          echo "$PWD/$VERAPDF_DIR" >> $GITHUB_PATH

      - name: Cache corpus downloads
        uses: actions/cache@v4
        with:
          path: /tmp/pdf-corpus
          key: pdf-corpus-v1

      - name: Run corpus security tests
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin:$PWD/$VERAPDF_DIR
          # veraPDF script name is usually 'verapdf'
          PDF_CORPUS_CACHE=/tmp/pdf-corpus go test -v ./sign -run TestSignCorpus -download-corpus -timeout 30m

FROM maven:3.9-eclipse-temurin-17 AS builder

RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
RUN git clone --depth 1 --branch 6.3 https://github.com/esig/dss-demonstrations.git /app/dss-demonstrations

WORKDIR /app/dss-demonstrations

# Set Maven options for memory and batch mode
ENV MAVEN_OPTS="-Xmx2048m"

# Build the project to produce the fat JAR
# Skipping tests and javadocs
RUN mvn clean install -pl dss-demo-webapp -am -DskipTests -Dmaven.javadoc.skip=true -Dmdep.skip=true

# Final stage
FROM eclipse-temurin:17-jre

WORKDIR /app

# Copy the built JAR from the builder stage
COPY --from=builder /app/dss-demonstrations/dss-demo-webapp/target/dss-demo-webapp-*.jar app.jar

EXPOSE 8080

# Run the Spring Boot application directly with Java to avoid Maven overhead at runtime
ENTRYPOINT ["java", "-Xmx1g", "-jar", "app.jar"]
